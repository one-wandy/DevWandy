

{% extends "base/base.html" %}
{% block content %}
{% load humanize %}
{% load static %}

<style>
            .btn-cliente
            {
                  background-color: #eeeeee !important;
            }
            .text-black-50 
            {
                  font-size: 14px;
            }
            .credits li 
            {
                  list-style: none;
            }
            .extends-div
            {
                  display: block !important;
                
            }
            .surper-bg
            {
                  background-color: rebeccapurple !important;
            }
            .inputs  
            {
                  border: 1px rgb(255, 255, 255);
                  outline: none !important;
            }
            .di-cn {
                  border-radius: 1.5rem;
                  padding: 0.5rem 1rem;
                  display: inline-block;
                  margin: 0.2rem;
                  width: max-content;
            }  
            .di-cn span
            {
                  color: #909090 !important;
                  font-size: 12px;
            }
            .di-cn strong
            {
                  color: #acacac !important;
                  font-size: 12px ;
            }
            table td 
            {
                  font-size: 13px; color: #7e7e7ebc;
            }
            table th 
            {
                  font-size: 14px; color: #7e7e7ebc;
            }
            .fixed-bottom {
                  background-color: #343a40;
                  color: white;
                  text-align: center;
                  padding: 0.5rem;
                  width: 100%;
            }
            .btn-apple {
                  display: inline-block;
                  padding: 0.5rem 1rem !important;
                  border-radius: 1.5rem;
                  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 6px 20px rgba(0, 0, 0, 0.1) !important;
                  background-color: rgba(237, 237, 237, 0.396) !important;
                  color: #797979;
                  font-size: 14px;
                  font-weight: normal;
                  text-align: center;
                  text-decoration: none;
                  transition: all 1s ease;
                  width: max-content !important;
            }
            .btn-apple:hover {    
                  box-shadow: 5px 5px 10px #d9d9d9, -5px -5px 10px #ffffff;
            }
            .py-3 img 
            {
                  margin-right: 0.5rem;
                  width: 20px;
            }
            .btn-es 
            {
                  background-color: rgba(125, 125, 125, 0);
                  color: rgb(117, 117, 117);
                  border: 0px;
                  border-radius: 2rem;
            }
            .btn-es-on
            {
                  background-color: rgb(126, 171, 255);
                  color: white;
            } 
            .input-of
            {
                  background-color: #efefef !important;
                  border: none !important;
            }
            .super-shadow {
                  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 6px 20px rgba(0, 0, 0, 0.1) !important;
                  background-color: rgba(237, 237, 237, 0.396) !important;
            }
            /* Definimos el efecto de flip-up */
            @keyframes flip-up {
            0% {
                  transform: rotateX(90deg);
                  opacity: 0;
            }
            100% {
                  transform: rotateX(0deg);
                  opacity: 1;
            }
            }

            /* Clase que aplicará la animación */
            .flip-up {
            animation: flip-up 0.8s ease-in-out;
            transform-origin: top; /* Punto de rotación */
            opacity: 0; /* Oculto por defecto */
            }


            /* Definimos el efecto de flip-down */
            @keyframes flip-down {
            0% {
                  transform: rotateX(-90deg);
                  opacity: 0;
            }
            100% {
                  transform: rotateX(0deg);
                  opacity: 1;
            }
            }

            /* Clase que aplicará la animación */
            .flip-down {
            animation: flip-down 1s ease-out ;
            transform-origin: top; /* Punto de rotación */
            opacity: 0; /* Oculto por defecto */
            }

            .green-span {
                        background-color: #ebf4ff; /* Light green background */
                        color: #005180; /* Green text */
                        font-weight: bold;
                        font-size: 12px;
                        padding: 0.2rem 0.5rem;
                        border-radius: 1rem;
            }
            .grey-span {
                  background-color: #ececec8d; /* Light green background */
                        color: #aaaaaa !important; /* Green text */
                        font-weight: bold;
                        font-size: 12px;
                        padding: 0.2rem 0.5rem;
                        border-radius: 1rem;
            }
            @keyframes moveInCircle {
                  0% {
                        transform: rotate(0deg) translateX(50px) rotate(0deg);
                  }
                  100% {
                        transform: rotate(360deg) translateX(50px) rotate(-360deg);
                  }
            }

            .colors {
                  animation: moveInCircle 7s linear infinite;
            }
</style>
<div  class="w-100 position-absolute bottom-top h-100 d-flex justify-content-around flex-wrap align-content-center" style="filter: blur(70px);" >
      <div class="colors uno" style="background-color: hsl(254, 100%, 83%); margin-left: 1rem;margin-bottom: 15rem;"></div>
      <div class="colors dos" style="margin-left: 2rem !important; margin-top: 19rem; background-color: rgb(85, 243, 238);"></div>
      <div class="colors tres" style="margin-left: 5rem; margin-top: 5rem; background-color: rgb(255, 160, 151);"></div>
</div>
<section data-aos="fade-down" class='d-flex credits  overflow-scroll bg-white bg-opacity-10 h-100 position-relative  justify-content-center flex-wrap'>
      <div class="d-flex w-100 justify-content-start  ">
            {% include "customer/user-profile.html" %}  
      </div>
      <!-- <div class="w-100 p-2">
            <strong class="text-black-50" style="font-size: 12px;">
                  Acciones
            </strong>
      </div> -->
      <div class="w-100 d-flex  justify-content-around flex-wrap " >
            {% if cuotas %}   
            <div class="d-flex justify-content-center w-100 py-3">
                  <button data-aos="fade-right" id="{{c.id}}" class="btn btn-apple btn-primary mx-2" onclick="OpenCloseBtnCredit(this.id)"> 
                        <img src="{% static "icons/mas.png" %}" width='24' alt=""> Abrir credito</button>
                  <button data-aos="fade-right" class="btn btn-apple btn-primary mx-2" onclick="toggleDiv('historial')"> 
                        <img src="{% static "icons/movimiento.png" %}" width='24' alt=""> Movimientos</button>
                  <button data-aos="fade-right" class="btn btn-apple btn-primary mx-2" onclick="toggleDiv('factura')">
                        <img src="{% static "icons/recibo.png" %}" width='24' alt=""> Generar Factura</button>
                  <button data-aos="fade-right" class="btn btn-apple btn-primary mx-2" onclick="toggleDiv('voucher')"> 
                        <img src="{% static "icons/comprobante.png" %}" width='24' alt="">  Comprobantes</button>
                  <button data-aos="fade-right" class="btn btn-apple btn-primary mx-2" onclick="toggleDiv('voucher')"> 
                        <img src="{% static "icons/notify.png" %}" width='24' alt="">  Recordatorio</button>
                        <button data-aos="fade-right" class="btn btn-apple btn-primary mx-2" > 
                        <a class="" href="{% url "customer:update-credit" credit.id %}">
                              <img src="{% static "icons/editar.png" %}" width='24' alt="">  Editar
                        </a>
                  </button>
            </div>
            <div  class='d-flex flex-wrap d-none bg-white mb-3 p-2 mt-2 ' id='div-credit{{c.id}}'
            style="border-radius: 1.5rem;">
            <section class="d-flex w-100  justify-content-center ">
  
                  <div class='form-floating w-100 m-1 justify-content-center' >
                        <input type="text" class='form-control monto-input  ' value="999" id='monto{{c.id}}' placeholder='Monto a recibir' style='border-radius:2rem !important; '>
                        <label for="monto{{c.id}}">Monto requirido</label>
                  </div>

                  <div class="form-floating w-100 m-1 justify-content-center">
                        <input type="date"   class=' form-control' id='dia{{c.id}}'  style=" border-radius: 2rem;">
                        <label for="dia{{c.id}}">Dia de pago</label>
                  </div>
            </section>
            <div class="w-100">
                  <span id="result-cuota{{c.id}}">

                  </span>
            </div>
            <div class=''>
                  
                  <input type="text" class='m-0 mt-1 d-none  form-control input' id='monto_pagar{{c.id}}' placeholder='Monto a pagar' style='border-radius:2rem !important;'>
            </div>
            <span class='d-flex pe-2 mt-1 w-100 justify-content-end'>

                  <button onclick="restar(this.id)" class='bg-transparent border-0 m-0 me-2 p-0' id='{{c.id}}'>
                        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-dash-circle text-danger" viewBox="0 0 16 16">
                              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                              <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8"/>
                            </svg>
                        {% comment %} Restar {% endcomment %}
                  </button>
                  
                  <input type="number" min="0" class='m-0 text-center border-0  overflow-visible bg-transparent' value='1' id='cuotas{{c.id}}'   style='max-width: 3rem !important;' placeholder='Cuotas'>
                  <button onclick="sumar(this.id)" class='border-0 bg-transparent p-0 m-0 ' id='{{c.id}}'>
                        {% comment %} Sumar {% endcomment %}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-plus-circle text-primary" viewBox="0 0 16 16">
                              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                              <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                            </svg>
                  </button>
            </span>
            <div class='w-100 mt-4 pt-3 d-flex  justify-content-end'>
                  <button onclick='OpenCloseBtnCredit(this.id)' id='{{c.id}}' class=' bg-transparent border-0'>Cancelar</button>
                  <button onclick='CreateCreditAjax(this.id)' id='{{c.id}}' class='text-white border-0 ' style='background-image: radial-gradient(circle 248px at center, #16d9e3 0%, #30c7ec 47%, #46aef7 100%);border-radius: 1.5rem; width: 7rem;'> Crear</button>
            </div>

      </div>
            <div class="w-100 p-2  ">
                  <strong class="text-black-50" style="font-size: 12px;">
                        Listados de creditos
                  </strong>
            </div>
            <div class='d-flex justify-content-start p-2 pb-3 overflow-scroll   w-100 align-content-center '>
                  {% include "components/list-credi.html" %}
            </div>
            

            <div class="justify-content-center  w-100   bottom-0 d-flex rounded-0" 
            style="background-color: #ffffff00; border-top: 0px rgb(207, 207, 207) solid; ">
            <div class="di-cn">
                  <strong>Capital:</strong> <span class="grey-span">${{ credit.amount|intcomma }}.00</span>
            </div>
            <div class="di-cn">
                  <strong>Tasa:</strong> <span class="grey-span"> 
                        {% if credit.tasa == 0 %}
                              15%
                        {% else %}
                              {{ credit.tasa }}%
                        {% endif %}
                        </span>
            </div>
            {% comment %} <div class="di-cn">
                  <strong>Capital mas intereses:</strong> <span class="grey-span" >
                        {% if cc == 1 %}
                        $00.00
                        {% else %}
                        ${{ cc|intcomma }}.00
                        {% endif %}
                  </span>
            </div> {% endcomment %}
            <div class="di-cn">
                  <strong>Total pagado:</strong> <span class="grey-span">${{ cp|intcomma }}.00</span>
            </div>
            <div class="di-cn">
                  <strong>Total al saldo:</strong> <span class="grey-span"> 
                        {% if cc == 1 %}
                        $00.00
                        {% else %}
                        ${{ cc|intcomma }}.00
                        {% endif %}
                  </span>
            </div>
            <div class="di-cn">
                  <strong>Cuotas:</strong> <span class="grey-span">{{ p_cuotas }} / {{c_cuotas}} </span>
            </div>
      
            </div>
                
           <div class=" rounded-5 me-2 ms-2 w-100 shadow bg-white bg-opacity-50  mb-2 d-flex flex-wrap justify-content-center overflow-scroll " style="height: 40vh;   ">
            <table class=" w-100 b rounded-4 m-3  ">
                  <thead>
                        <tr>
                              <th>#</th>
                              <th>Cuota</th>
                              <th>Mora</th>
                              <th>Monto pagado</th>
                              <th>Restante</th>
                              <th>Estado de cuota</th>
                              <th>Termina</th>
                              <th>Vence</th>
                              <th style="width: 20rem;">Acciones de aplicar pago </th>
                        </tr>
                  </thead>
                  
                  <tbody >
                        
                        {% for cuota in cuotas %}
                        <tr>
                              <td>{{ forloop.counter }}</td>
                              <td> 
                                    <span class="grey-span">

                                          ${{ cuota.cuota|intcomma }}.00 
                                    </span>
                              </td>
                              <td> ... </td>
                              <td>
                                    {% if cuota.abonado > 0 %}
                                    <span class="grey-span">
                                    ${{ cuota.abonado|intcomma }}.00
                              </span>  
                                    {% else %}
                                          ...
                                    {% endif %}
                              </td>
                              <td>
                                    {% if cuota.abonado > 0 %}
                                  <span class="grey-span">

                                        ${{ cuota.restante|intcomma }}.00
                                  </span>  
                                    {% else %}
                                          ...
                                    {% endif %}
                              </td>
                              <td >  {% if cuota.estado %}  
                                    <span class="green-span">
                                          Completado
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-patch-check-fill  text-primary" viewBox="0 0 16 16">
                                          <path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708"/>
                                          </svg> 

                                          </span>
                                          {% else %}
                                          ...

                                    {% endif %}  </td>
                                    <td class="text-capitalize"> {{cuota.start_date|date:"m/d/Y"}} </td>
                                    <td class="text-capitalize"> {{cuota.end_date|date:"m/d/Y"}} </td>

                              <td class=" ">
                                    {% if cuota.estado == True %}
                                          ...
                                    {% else %}
                                    <div class="d-flex " style="height: 2.5rem;">
                                          <input type="text" id="ct-p{{ cuota.id }}" class="bg-white  bg-opacity-10 inputs  p-2  outline-none" placeholder="Cantidad" min="1" max="{{ cuota.restante }}" style="border-radius: 1.5rem; width: 6rem; 
                                          border: 1px solid rgb(213, 213, 213)  ;">
                                          <button onclick="AplicarPago(this.id)" disabled="true" class=' btn-es' id="{{ cuota.id }}"></button>
                                    </div>
                                    {% endif %}
                              </td>
                        </tr>
                        {% endfor %}
                  </tbody>
            </table> 
      </div>
  
            {% endif %}
      </div>
      
      
      {% if cuotas == none %}
      <form action="" method="post">
            {% csrf_token %}
            {{form}}
            <button class="bg-white" style="border-radius: 2rem;"> Abrir nuevo credito de  ${{credit.amount|intcomma}}.00  </button>
      </form>
      {% endif %}
      
      
      <div class=" position-sticky bottom-0 w-100 start-0  text-white text-center ">

            <div id="historial" class="position-absolute top-50 start-50 translate-middle bg-white p-3 d-none" style="z-index: 1050;">
                  <button class="btn btn-danger" onclick="closeDiv('historial')">Cerrar</button>
                  <p>Contenido del Historial</p>
            </div>

            <div id="factura" class="position-absolute top-50 start-50 translate-middle bg-white p-3 d-none" style="z-index: 1050;">
                  <button class="btn btn-danger" onclick="closeDiv('factura')">Cerrar</button>
                  <p>Contenido de Generar Factura</p>
            </div>

            <div id="voucher" class="position-absolute top-50 start-50 translate-middle bg-white p-3 d-none" style="z-index: 1050;">
                  <button class="btn btn-danger" onclick="closeDiv('voucher')">Cerrar</button>
                  <p>Contenido del Voucher</p>
            </div>

            <script>
            function toggleDiv(divId) {
                  const divs = ['historial', 'factura', 'voucher'];
                  divs.forEach(id => {
                        if (id === divId) {
                              document.getElementById(id).classList.toggle('d-none');
                        } else {
                              document.getElementById(id).classList.add('d-none');
                        }
                  });
            }

            function closeDiv(divId) {
                        document.getElementById(divId).classList.add('d-none');
                  }
            </script>
      </div>

</section>
<input type="number" value="{{cc}}" class="d-none input-ip">
<input type="text" id="{{cuotas.id}}" class="d-none inp-id">
<input type="text" id="cuotas_credit{{credit.id}}" class="d-none input-credit">
<script>
      window.onload = () => {
       
            let input_id = document.querySelector(".inp-id");
            if (input_id) {
                  document.querySelector('#div-more'+input_id.id).classList.add('surper-bg')
            }
            
     
   
        };

      let input_credit = document.querySelector(".input-credit");
      if (input_credit) {
            document.getElementById(input_credit.id).classList.add('super-shadow', 'flip-up') ;
      }
function AplicarPago(ID){

            let input = document.getElementById('ct-p'+ID).value

  
      $.ajax({
            url:  '/aplicar-pago',
            data: {
                  id: ID,
                  input:   input.replace(/,/g, ''),
            },
            success: (D) => { 
                  if (document.getElementById(D.id)) {
                        document.getElementById(D.id).classList.add('d-none');
                  }
                  if (document.getElementById('check' + D.id)) {
                        document.getElementById('check' + D.id).classList.remove('d-none');
                  }  location.reload();
            } 
      })
}

document.querySelectorAll('.inputs').forEach(input => {
      input.addEventListener('input', function(e) {

            
            let btnID = this.id.replace(/\D/g, '');
            // Remueve todo lo que no sea dígito
            let value = this.value.replace(/\D/g, '');
            
            // Convierte el valor a número y lo compara con el máximo
            let max = parseInt(this.getAttribute('max'));
            console.log(max);
 
            if (parseInt(value) > max) {
                  // Si el valor es mayor al máximo, ajusta el valor al máximo permitido
                  // value = max.toString();
            }

            // Añade comas en los lugares correctos
            this.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // Cambia el borde si el valor es igual al máximo
            if (parseInt(value) === max) {
                  this.style.border = '2px solid green';
            } else {
                  this.style.border = ''; // Restablece el estilo original si no es igual al máximo
                  this.style.border = '1px solid #efefef';
            }

            // Evita letras y otros caracteres no numéricos
            if (/\D/.test(e.data)) {
                  this.value = this.value.replace(e.data, '');
            }

            // Muestra el botón si hay un valor en el input
            if (value) {
                  document.getElementById(btnID).disabled = false;
                  document.getElementById(btnID).classList.add('btn-es-on');
                  
                  
            document.getElementById(btnID).textContent = 'Abonar';
            if (parseInt(value) > max) {
                  this.style.border = '2px solid green';
            } 
            else if (parseInt(value) == max) {
                  let ab = max
                   document.getElementById(btnID).textContent = 'Saldar cuota $' + ab.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');  
                  
            }
            
            
            if (parseInt(value) > max){
                  let ab = parseInt(value)  - max
                  document.getElementById(btnID).textContent = 'Saldar y abonar $' + ab.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');  
                  if (parseInt(value) >= parseInt(document.querySelector('.input-ip').value)) {
                        this.value = parseInt(document.querySelector('.input-ip').value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        document.getElementById(btnID).textContent = 'Saldar prestamo $' + this.value;
                  } 
             }


            } else {
                  document.getElementById(btnID).disabled = true;
                  document.getElementById(btnID).textContent = '';
                  document.getElementById(btnID).classList.remove('btn-es-on');
            }  });
});

document.querySelectorAll('.inputs').forEach((input, index) => {
      if (index > 0) {
            input.disabled = true;  
            input.classList.add('input-of');
            input.setAttribute('placeholder', 'N/A');
            


            
      }
});

function OpenCloseBtnCredit(btn_id) {
      const div = document.getElementById('div-credit' + btn_id);
      if (div.classList.contains('d-none')) {
            div.classList.remove('d-none');
            div.classList.add('d-block');
      } else if (div.classList.contains('d-block')) {
            // document.getElementById('div-list-customer').classList.add('   ')
            div.classList.remove('d-block');
            div.classList.add('d-none');
      }
}

function sumar(n) {
      var inputNumero = document.getElementById("cuotas"+n);
      var valorActual = parseInt(inputNumero.value);
      inputNumero.value = valorActual + 1;
      let numero_input = document.getElementById("monto"+n)
      let numero = numero_input.value.replace(/,/g, ''); // Elimina las comas existentes
      let capital = parseInt(numero)
      SuperCalAuto(capital, document.querySelector("#cuotas"+n).value, 
      0.15, 
      "result-cuota"+n,
      n
      )
};

function restar(n) {
      var inputNumero = document.getElementById("cuotas"+n);
      var valorActual = parseInt(inputNumero.value);
      let numero_input = document.getElementById("monto"+n)
      if(valorActual > 0) {
            inputNumero.value = valorActual - 1;
      }

      let numero = numero_input.value.replace(/,/g, ''); // Elimina las comas existentes
      let capital = parseInt(numero)
      SuperCalAuto(capital, document.querySelector("#cuotas"+n).value, 
      0.15, 
      "result-cuota"+n,
      n
      )
}



</script>
{% endblock  %}